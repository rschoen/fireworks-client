
<dom-module id="fireworks-stats">

<style>
google-chart {
  width: 350px;
  height: 200px;
  margin-top: 10px;
}
#heading { 
  font-size: 35pt;
  margin-right: 145px;
}
table { font-size: 11px; border-collapse: collapse; }
table td, table th { border: 1px solid #AAA; padding: 3px; }
td { text-align: center; }
td.name { text-align: left; }
</style>
  
  <template>
  <span id='heading'>Stats</span><paper-button raised on-tap='requestStats'>Refresh</paper-button>
  <h2>Game results</h2>
  <table class="stats">
  <tr><th></th><th>Games</th><th>Perfect</th><th>Bombed out</th><th>Out of plays</th><th>Avg score</th></tr>
  <template is="dom-repeat" items="{{stats}}" as="item">
  <tr>
  <td class='name'>[[item.name]]</td>
  <td><span>[[item.games]]</span></td>
  <td><span>[[item.perfectGames]]</span> <span>[[_computePercent(item.perfectGames,item.games)]]</span></td>
  <td><span>[[item.bombedGames]]</span> <span>[[_computePercent(item.bombedGames,item.games)]]</span></td>
  <td><span>[[item.outOfPlays]]</span> <span>[[_computePercent(item.outOfPlays,item.games)]]</span></td>
  <td><span>[[item.score]]</span></td>
  </tr>
  </template>
  </table>
  <div id="chart"><div></div></div>
	<h2>Turn stats</h2>
  <table class="stats">
  <tr><th></th><th>Moves</th><th>Plays</th><th>Bombs</th><th>Discards</th><th>Hints</th><th>Avg time</tr>
  <template is="dom-repeat" items="{{stats}}" as="item">
  <tr>
  <td class='name'>[[item.name]]</td>
  <td><span>[[item.moves]]</span></td>
  <td><span>[[item.plays]]</span> <span>[[_computePercent(item.plays,item.moves)]]</span></td>
  <td><span>[[item.bombs]]</span> <span>[[_computePercent(item.bombs,item.moves)]]</span></td>
  <td><span>[[item.discards]]</span> <span>[[_computePercent(item.discards,item.moves)]]</span></td>
  <td><span>[[item.hints]]</span> <span>[[_computePercent(item.hints,item.moves)]]</span></td>
  <td><span>[[item.time]]</span>s</span></td>
  </tr>
  </table>
  </template>

  </template>

  <script>

    Polymer({
      is: "fireworks-stats",

      properties: {
      	stats: {
      		type: Array
      	}
      },

      requestStats: function () {
        document.getElementById("gamecontroller").requestStats();
      },
      
      processJSON: function(json) {
        this.stats = Array();
        globalStats = this.makeStatsArray(json.Stats);
        globalStats.name = "Overall"
        this.push("stats", globalStats)

        for(var i=0; i<json.Players.length; i++) {
          userStats = this.makeStatsArray(json.Players[i].Stats);
          userStats.name = json.Players[i].Name;
          this.push("stats", userStats)
        }
        this.createAndAttachStatsChart("chart",json.Stats.Scores)
      },

      _computeDataRows: function(scores) {
        rows = Array();
        for(i in scores) {
          rows.push( [i, scores[i]] )
        }
        text = JSON.stringify(rows);
        return "[ " + text.slice(1);
      },

      createStatsChart: function(data) {
        var chartAttributes = {
          'id': "mychart",
          'type': 'column',
          'options': '{"title": "Overall score distribution", "chartArea": {"width": "80%", "height": "70%"}, "legend": {"position": "none"}, "hAxis": {"showTextEvery": "2"}, "height": "200", "width": "350"}',
          'rows': this._computeDataRows(data),
          'cols': '[{"label": "Data", "type": "string"},{"label": "Value", "type": "number"}]',
        };

        var chart = document.createElement('google-chart');

        for (var key in chartAttributes) {
          chart.setAttribute(key, chartAttributes[key]);
        }
        Polymer.dom(this.root).appendChild(chart);
        return chart;
      },

      createAndAttachStatsChart: function(id, data) {
        var chartContainer = document.getElementById(id);
        chartContainer.appendChild(this.createStatsChart(data));
        chartContainer.children[0].remove();
        chartContainer.classList.remove("hidden")
      },

      makeStatsArray: function(s) {
        gs = Array();
        gs.games = s.FinishedGames
        gs.perfectGames = s.FinishedGames - (s.BombsLosses + s.TurnsLosses + s.NoPlaysLosses)
        gs.bombedGames = s.BombsLosses
        gs.outOfPlays = s.TurnsLosses + s.NoPlaysLosses
        gs.moves = s.Moves
        gs.plays = s.Plays
        gs.bombs = s.Bombs
        gs.hints = s.Hints
        gs.discards = s.Discards
        gs.score = this.getMeanScore(s.Scores)
        gs.time = Math.round(s.TurnTime / s.Moves * 10)/10
        return gs
      },

      getMeanScore(scores){
        total = 0
        games = 0
        for(i in scores) {
          total += i * scores[i];
          games += scores[i]
        }
        return total/games
      },

      _computePercent(num, den) {
        if(den==0) {
          return ""
        }
        percent = Math.round(num / den * 100)
        return "(" + percent + "%)"
      }

    });
  </script>

</dom-module>
