
<dom-module id="fireworks-stats">

<style>
google-chart {
  width: 500px;
  height: 200px;
}
.hidden { 
display: none;
}

div.stat {
  width: 75px;
  height: 75px; 
  display: inline-block;
  margin: 10px;
  padding: 5px;
  border: 1px solid #AAA;
}
div.stat div { display: block; width: 100%; text-align: center; vertical-align: middle;}
div.name { font-size: 10pt; height: 30px;}
div.percent { font-size: 12pt; height: 30px; }
div.subtext { font-size: 8pt; height: 15px;}
</style>
  
  <template>
  <paper-button raised on-tap='requestStats'>Refresh</paper-button>
	<h2>Overall</h2>
  <template is="dom-repeat" items="{{globalStats}}" as="item">
  <div class="stat"><div class='name'>[[item.name]]</div><div class='percent'>[[_computePercentage(item)]]</div><div class='subtext'>[[_computeSubtext(item)]]</div></div>
  </template>

 <div id="chart"><div></div></div>

    <template is="dom-repeat" items="{{users}}" as="item" id="usertemplate">
      <h2>[[item.name]]</h2>
      <template is="dom-repeat" items="{{item.stats}}" as="userStat">
  <div class="stat"><div class='name'>[[userStat.name]]</div><div class='percent'>[[_computePercentage(userStat)]]</div><div class='subtext'>[[_computeSubtext(userStat)]]</div></div>
      </template>
      <fireworks-chart-helper chart="[[item.chart]]"></fireworks-chart-helper>
    </template>
  </template>

  <script>

    Polymer({
      is: "fireworks-stats",

      properties: {
      	globalStats: {
      		type: Array
      	},
        users: {
          type: Array
        }
      },

      requestStats: function () {
        document.getElementById("gamecontroller").requestStats();
        this.$.chart.classList.add("hidden")
        this.globalStats = Array();
        this.users = Array();
      },
      
      processJSON: function(json) {
        this.globalStats = Array();
        this.users = Array();
        s = json.Stats
        this.push('globalStats', {name: "Games completed", num: s.FinishedGames, den: s.StartedGames})
        this.push('globalStats', {name: "Perfect", num: s.FinishedGames - (s.BombsLosses + s.TurnsLosses + s.NoPlaysLosses), den: s.FinishedGames})
        this.push('globalStats', {name: "Bombed out", num: s.BombsLosses, den: s.FinishedGames})
        this.push('globalStats', {name: "Ran out of turns", num: s.TurnsLosses, den: s.FinishedGames})
        this.push('globalStats', {name: "No plays left", num: s.NoPlaysLosses, den: s.FinishedGames})

        for(i in json.Players) {
          u = json.Players[i].Stats
          user = {id: json.Players[i].ID, name: json.Players[i].Name, stats: Array()};

          user.stats.push({name: "Games completed", num: u.FinishedGames, den: u.StartedGames})
          user.stats.push({name: "Perfect", num: u.FinishedGames - (u.BombsLosses + u.TurnsLosses + u.NoPlaysLosses), den: u.StartedGames})
          user.stats.push({name: "Bombed out", num: u.BombsLosses, den: u.StartedGames})
          user.stats.push({name: "Ran out of turns", num: u.TurnsLosses, den: u.StartedGames})
          user.stats.push({name: "No plays left", num: u.NoPlaysLosses, den: u.StartedGames})

          user.stats.push({name: "Mean turn time", value: Math.round(u.TurnTime / u.Moves * 10,2)/10, units: "seconds"})
          user.stats.push({name: "Plays", num: u.Plays, den: u.Moves})
          user.stats.push({name: "Bombs", num: u.Bombs, den: u.Moves})
          user.stats.push({name: "Hints", num: u.Hints, den: u.Moves})
          user.stats.push({name: "Discards", num: u.Discards, den: u.Moves})

          user.chart = this.createStatsChart(u.Scores)
          this.push('users', user);
        }
        this.createAndAttachStatsChart("chart",s.Scores)
      },

      _computeDataRows: function(scores) {
        rows = Array();
        for(i in scores) {
          rows.push( [i, scores[i]] )
        }
        text = JSON.stringify(rows);
        return "[ " + text.slice(1);
      },

      createStatsChart: function(data) {
        var chartAttributes = {
          'id': "mychart",
          'type': 'column',
          'options': '{"title": "Overall score distribution", "legend": {"position": "none"}, "hAxis": {"showTextEvery": "2"}, "height": "200", "width": "500"}',
          'rows': this._computeDataRows(data),
          'cols': '[{"label": "Data", "type": "string"},{"label": "Value", "type": "number"}]',
        };

        var chart = document.createElement('google-chart');

        for (var key in chartAttributes) {
          chart.setAttribute(key, chartAttributes[key]);
        }
        Polymer.dom(this.root).appendChild(chart);
        return chart;
      },

      createAndAttachStatsChart: function(id, data) {
        var chartContainer = document.getElementById(id);
        chartContainer.appendChild(this.createStatsChart(data));
        chartContainer.children[0].remove();
        chartContainer.classList.remove("hidden")
      },

      _computePercentage(stat) {
        if(typeof stat.value === 'undefined')
        {
          return Math.round(stat.num / stat.den * 100) + "%"
        }
        else {
          return stat.value
        }
      },

      _computeSubtext(stat) {
        if(typeof stat.value === 'undefined')
        {
          return stat.num + " / " + stat.den
        }
        else {
          return stat.units
        }
      }

    });
  </script>

</dom-module>
