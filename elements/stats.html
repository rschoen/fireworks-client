
<dom-module id="fireworks-stats">

<style>
google-chart {
  width: 500px;
  height: 200px;
}
</style>
  
  <template>
  <paper-button raised on-tap='requestStats'>Refresh</paper-button>
	<h2>Overall</h2>
  <ul>
  <template is="dom-repeat" items="{{globalStats}}" as="item">
    <li><span>[[item.name]]</span>: <span>[[item.stat]]</span>
  </template>
  </ul>

 <div id="chart"><div></div></div>

    <template is="dom-repeat" items="{{users}}" as="item" id="usertemplate">
      <h2>[[item.name]]</h2>
      <ul>
      <template is="dom-repeat" items="{{item.stats}}" as="userStat">
        <li><span>[[userStat.name]]</span>: <span>[[userStat.stat]]</span>
      </template>
      </ul>
      <fireworks-chart-helper chart="[[item.chart]]"></fireworks-chart-helper>
    </template>
  </template>

  <script>

    Polymer({
      is: "fireworks-stats",

      properties: {
      	globalStats: {
      		type: Array
      	},
        users: {
          type: Array
        }
      },

      requestStats: function () {
        document.getElementById("gamecontroller").requestStats();
      },
      
      processJSON: function(json) {
        this.globalStats = Array();
        this.users = Array();
        s = json.Stats
        this.push('globalStats', {name: "Started games", stat: s.StartedGames})
        this.push('globalStats', {name: "Finished games", stat: s.FinishedGames})
        this.push('globalStats', {name: "Perfect games", stat: s.FinishedGames - (s.BombsLosses + s.TurnsLosses + s.NoPlaysLosses)})
        this.push('globalStats', {name: "Bombed out", stat: s.BombsLosses})
        this.push('globalStats', {name: "Ran out of turns", stat: s.TurnsLosses})
        this.push('globalStats', {name: "No plays left", stat: s.NoPlaysLosses})

        for(i in json.Players) {
          u = json.Players[i].Stats
          user = {id: json.Players[i].ID, name: json.Players[i].Name, stats: Array()};

          user.stats.push({name: "Started games", stat: u.StartedGames})
          user.stats.push({name: "Finished games", stat: u.FinishedGames})
          user.stats.push({name: "Perfect games", stat: u.FinishedGames - (u.BombsLosses + u.TurnsLosses + u.NoPlaysLosses)})
          user.stats.push({name: "Bombed out", stat: u.BombsLosses})
          user.stats.push({name: "Ran out of turns", stat: u.TurnsLosses})
          user.stats.push({name: "No plays left", stat: u.NoPlaysLosses})

          user.stats.push({name: "Turns taken", stat: u.Moves})
          user.stats.push({name: "Average turn time", stat: Math.round(u.TurnTime / u.Moves * 10,2)/10 + " seconds"})
          user.stats.push({name: "Successful plays", stat: u.Plays})
          user.stats.push({name: "Bombs", stat: u.Bombs})
          user.stats.push({name: "Hints", stat: u.Hints})
          user.stats.push({name: "Discards", stat: u.Discards})

          user.chart = this.createStatsChart(u.Scores)
          this.push('users', user);
        }
        this.createAndAttachStatsChart("chart",s.Scores)
      },

      _computeDataRows: function(scores) {
        rows = Array();
        for(i in scores) {
          rows.push( [i, scores[i]] )
        }
        text = JSON.stringify(rows);
        return "[ " + text.slice(1);
      },

      createStatsChart: function(data) {
        var chartAttributes = {
          'id': "mychart",
          'type': 'column',
          'options': '{"title": "Overall score distribution", "legend": {"position": "none"}, "hAxis": {"showTextEvery": "2"}, "height": "200", "width": "500"}',
          'rows': this._computeDataRows(data),
          'cols': '[{"label": "Data", "type": "string"},{"label": "Value", "type": "number"}]',
        };

        var chart = document.createElement('google-chart');

        for (var key in chartAttributes) {
          chart.setAttribute(key, chartAttributes[key]);
        }
        Polymer.dom(this.root).appendChild(chart);
        return chart;
      },

      createAndAttachStatsChart: function(id, data) {
        var chartContainer = document.getElementById(id);
        chartContainer.children[0].remove();
        chartContainer.appendChild(this.createStatsChart(data));
      },

      _userChartName: function(id) {
        return "user"+id
      },

      _callback: function(chart) {
        window.alert(chart);
      }

    });
  </script>

</dom-module>
