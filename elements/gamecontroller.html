
<dom-module id="fireworks-gamecontroller">
<style>
.hidden { display: none; }
</style>
  
  <template>
  <iron-ajax
	id="ajax"
	method="POST"}
    url="/api/"
    handle-as="json"
    on-response="handleResponse"
    debounce-duration="300"></iron-ajax>
	
	<div id="destroyable"><div id="nameform"><form on-submit="joinGame" action="#">Name: <input type="text" id="localPlayerName" value="Ryan"/><br />Game: <input type=text id="gameid" value="whatevs"/><br /><input type="submit" value="Join"/></form></div></div>
	<input type="button" value="Start Game" id="started" class="hidden" on-click="startGame" />
  </template>

  <script>
    Polymer({
      is: "fireworks-gamecontroller",

      properties: {
      	localPlayerName: {
      		type: String
      	},
      	gameid: {
      		type: String
      	},
      	gamesequence: {
      		type: Number,
      		readOnly: true
      	},
		polling: {
			type: Boolean,
			value: false
		}
	},
	
	joinGame: function(e) {
		e.preventDefault();
		var name = this.$.localPlayerName.value;
		var gameid = this.$.gameid.value;
		if(name != "" && gameid != "") {
			this.localPlayerName = name;
			this.gameid = gameid;
				
			var ajax = this.$.ajax;
			ajax.url="/api/join"
			ajax.body="data="+this.makeEmptyMove();
			ajax.generateRequest();
		
		}
	},
	
	startGame: function(e) {
		var ajax = this.$.ajax;
		ajax.url="/api/start"
		ajax.body="data="+this.makeEmptyMove();
		ajax.generateRequest();
	},
	
	makeEmptyMove: function()
	{
		var emptyMove = {Game: this.gameid,
				Player: this.localPlayerName,
				MoveType: 0,
				CardIndex: 0,
				HintPlayer: "0",
				HintInfoType: 0
				}
	
		return JSON.stringify(emptyMove);
	},
	
	handleResponse: function(request) {
		json = request.detail.response;
		// TODO actually send through the deck, piles, and other data
		var newGame = new FireworksGame(this.localPlayerName, json.Hints, json.Bombs, json.Piles, json.Discard, json.CardsLeft, json.Started);
		for(player in json.Players) {
			var thisPlayer = newGame.addPlayer(json.Players[player].ID,[]);
			for(card in json.Players[player].Cards) {
				thisPlayer.addCard(json.Players[player].Cards[card].Color, json.Players[player].Cards[card].Number);
			}
		}
		this.$.destroyable.innerHTML = "";
		Polymer.dom(this.root).appendChild(newGame);
		Polymer.dom(this.root).querySelector("#destroyable").appendChild(newGame);
	 
		
		if(json.Started) {
			this.$.started.classList.add("hidden");
		}
		else {
			this.$.started.classList.remove("hidden");
		}

		if(!this.polling)
		{
			this.polling = true;
			this.poll();
		}
	},
			
	
	poll: function() {
		ajax.url="/api/status"
		ajax.body="data="+this.makeEmptyMove();
		ajax.generateRequest();
		if(this.polling) this.async(this.poll, 5000);
	}
      
    });
  </script>

</dom-module>
