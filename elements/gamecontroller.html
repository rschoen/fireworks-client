
<dom-module id="fireworks-gamecontroller">
<style>
.hidden { display: none; }

#overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.3);
	z-index: 4;
}

#dialog {
	position: fixed;
	width: 200px;
	height: 100px;
	top: 50%;
	left: 50%;
	margin-top: -50px;
	margin-left: -100px;
	border: 1px solid #333;
	background: white;
	border-radius: 3px;
	padding: 20px;
	text-align: center;
	z-index: 5;
}

#dialog fireworks-card {
	margin-bottom: 10px;
}

#spinner {
	position: fixed;
	width: 100px;
	height: 100px;
	top: 50%;
	left: 50%;
	margin-top: -50px;
	margin-left: -50px;
	--spinner-stroke-width: 5px;
}

#startbutton {
	position: relative;
	top: 230px;
	left: 40px;
}

</style>
  
  <template>
  <iron-ajax
	id="ajax"
	method="POST"}
    url="/api/"
    handle-as="json"
    on-response="handleResponse"
    debounce-duration="300"></iron-ajax>
	
	<div id="destroyable" on-click="registerClick">
		<div id="nameform">
			<form on-submit="joinGame" action="#">
				Name: <input type="text" id="localPlayerName" value="{{suggestName}}"/><br />
				Game: <input type=text id="gameid" value="{{suggestGame}}"/><br />
				<input type="submit" value="Join"/>
			</form>
		</div>
	</div>
	<div id="startbutton" class="hidden">
		<input type="button" value="Start Game" id="started" on-click="startGame" />
	</div>
	<div id="modal" class="hidden">
		<div id="overlay" on-click="hideModal">
		</div>
		<div id="dialog">
			<fireworks-card id="dialogcard" faceup></fireworks-card>
			<div id="hintinputs">
				<input id="hintnumber" type="button" value="Hint Number" on-click="giveNumberHint" />
				<input id="hintcolor" type="button" value="Hint Color"  on-click="giveColorHint" />
			</div>
			<div id="playinputs" class="hidden">
				<input id="play" type="button" value="Play" on-click="play" />
				<input id="discard" type="button" value="Discard" on-click="discard" />
			</div>
		</div>
	</div>
	<div id="spinner" class="hidden">
		<paper-spinner active></paper-spinner>
	</div>
  </template>

  <script>
    Polymer({
      is: "fireworks-gamecontroller",

      properties: {
      	localPlayerName: {
      		type: String
      	},
      	gameid: {
      		type: String
      	},
      	gamesequence: {
      		type: Number,
      		readOnly: true
      	},
		polling: {
			type: Boolean,
			value: false
		},
		hintPlayerName: {
			type: String
		},
		hintCardIndex: {
			type: Number,
		},
		movePlay: {
			type: Number,
			readOnly: true,
			value: 1
		},
		moveDiscard: {
			type: Number,
			readOnly: true,
			value: 2
		},
		moveHint: {
			type: Number,
			readOnly: true,
			value: 3
		},
		infoNumber: {
			type: Number,
			readOnly: true,
			value: 1
		},
		infoColor: {
			type: Number,
			readOnly: true,
			value: 2
		},
		currentPlayer: {
			type: String
		},
		suggestName: {
			type: String
		},
		suggestGame: {
			type: String
		}
	},
	
	joinGame: function(e) {
		e.preventDefault();
		var name = this.$.localPlayerName.value;
		var gameid = this.$.gameid.value;
		if(name != "" && gameid != "") {
			this.localPlayerName = name;
			this.gameid = gameid;
				
			var ajax = this.$.ajax;
			ajax.url="/api/join"
			ajax.body="data="+this.makeEmptyMove();
			ajax.generateRequest();
		
		}
		this.$.startbutton.classList.remove("hidden");
	},
	
	startGame: function(e) {
		this.sendData("start",this.makeEmptyMove())
		this.$.startbutton.classList.add("hidden");
	},
	
	sendData: function(command, data) {
		var ajax = this.$.ajax;
		ajax.url = " /api/" + command;
		ajax.body = "data=" + data;
		ajax.generateRequest();
	},
	
	makeMove: function(movetype, cardindex, hintplayer, hintinfotype) {
		var move = {Game: this.gameid,
				Player: this.localPlayerName,
				MoveType: movetype,
				CardIndex: cardindex,
				HintPlayer: hintplayer,
				HintInfoType: hintinfotype
				};
	
		return JSON.stringify(move);
	},
	
	makeEmptyMove: function()
	{
		return this.makeMove(0, 0, "null", 0);
	},
	
	
	
	handleResponse: function(request) {
		json = request.detail.response;
		
		var newGame = new FireworksGame(this.localPlayerName, json.Hints, json.Bombs, json.Piles, json.Discard, json.CardsLeft, json.Started);
		for(player in json.Players) {
			var thisPlayer = newGame.addPlayer(json.Players[player].ID,[]);
			if(json.Players[player].ID == json.CurrentPlayer)
			{
				thisPlayer.setCurrentPlayer();
			}
			var index = 0;
			for(card in json.Players[player].Cards) {
				thisPlayer.addCard(json.Players[player].Cards[card].Color, json.Players[player].Cards[card].Number, json.Players[player].Cards[card].KnownColor, json.Players[player].Cards[card].KnownNumber, index);
				index++;
			}
		}
		this.$.destroyable.innerHTML = "";
		Polymer.dom(this.root).appendChild(newGame);
		Polymer.dom(this.root).querySelector("#destroyable").appendChild(newGame);
	 
		
		if(json.Started) {
			this.$.started.classList.add("hidden");
		}
		else {
			this.$.started.classList.remove("hidden");
		}

		if(!this.polling)
		{
			this.polling = true;
			this.poll();
		}
		this.currentPlayer = json.CurrentPlayer;
		this.hideSpinner();
	},
			
	
	poll: function() {
		ajax.url="/api/status"
		ajax.body="data="+this.makeEmptyMove();
		ajax.generateRequest();
		if(this.polling) this.async(this.poll, 5000);
	},
	
		  
	registerClick: function(event) {
		if(this.currentPlayer != this.localPlayerName) {
			return;
		}
	
		if(event.target.className.indexOf("fireworks-card") > -1) {
			var target = event.target;
			while(target.localName != "fireworks-card") {
				target = target.parentElement;
			}
			var number = target.getNumber();
			var color = target.getColor();
			this.$.dialogcard.setNumber(number);
			this.$.dialogcard.setColor(color);
			this.$.dialogcard.setKnownNumber(target.getKnownNumber());
			this.$.dialogcard.setKnownColor(target.getKnownColor());
			this.$.hintnumber.value = "Hint " + number;
			this.$.hintcolor.value = "Hint " + color;
			this.hintCardIndex = target.getIndex();
			
			while(target.localName != "fireworks-player") {
				if(target.parentElement == null) {
					return;
				}
				target = target.parentElement;
			}
			this.hintPlayerName = target.getName();
			
			if(this.hintPlayerName == this.localPlayerName) {
				this.$.dialogcard.setFaceup(false);
				this.$.dialogcard
				this.$.hintinputs.classList.add("hidden");
				this.$.playinputs.classList.remove("hidden");
				
			}
			else {
				this.$.dialogcard.setFaceup(true);
				this.$.hintinputs.classList.remove("hidden");
				this.$.playinputs.classList.add("hidden");
			}
			
			this.$.modal.classList.remove("hidden");
			
		}
	},
	
	hideModal: function() {
		this.$.modal.classList.add("hidden");
	},
	showSpinner: function() {
		this.$.spinner.classList.remove("hidden");
	},
	hideSpinner: function() {
		this.$.spinner.classList.add("hidden");
	},
	
	giveHint: function(infotype) {
		var data = this.makeMove(this.moveHint, this.hintCardIndex, this.hintPlayerName, infotype);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	},
	
	giveNumberHint: function() {
		this.giveHint(this.infoNumber);
	},
	giveColorHint: function() {
		this.giveHint(this.infoColor);
	},
	
	play: function () {
		this.playOrDiscard(this.movePlay);
	},
	discard: function() {
		this.playOrDiscard(this.moveDiscard);
	},
	playOrDiscard: function(movetype) {
		var data = this.makeMove(movetype, this.hintCardIndex, this.hintPlayerName, 0);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	}
	
    });
  </script>

</dom-module>
