
<dom-module id="fireworks-gamecontroller">
<style>
.hidden { display: none; }

#overlay {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(100, 100, 100, 0.1);
	z-index: 4;
}

#dialog {
	position: absolute;
	width: 230px;
	top: 50%;
	left: 50%;
	margin-top: -100px;
	margin-left: -120px;
	border: 1px solid #333;
	background: white;
	border-radius: 3px;
	padding: 15px;
	text-align: center;
	z-index: 5;
}

#dialog fireworks-card {
	margin-bottom: 10px;
}

#spinner {
	position: fixed;
	width: 30px;
	height: 30px;
	top: 50%;
	left: 50%;
	margin-top: -15px;
	margin-left: -15px;
	--spinner-stroke-width: 5px;
}

#start {
	position: relative;
	top: -90px;
    height: 0px;
    width: 285px;
    text-align: center;
}

#end div {
    margin-top: 20pt;
    font-size: 18pt;
    font-weight: bold;
}

#error span {
    color: red;
}
#error div {
    margin-top: 30px;
}

input {
    font-size: 16pt;
}


#destroyable {
    height: 505px;
}

#gameid { 
    margin-bottom: 20px;
}
#buttoncontainer {
    text-align: right;
}
#newgame {

    text-align: left;
}
paper-button {
    background: #006;
    color: white;
}

</style>
  
  <template>
  <iron-ajax
	id="ajax"
	method="POST"}
    url="/api/"
    handle-as="json"
    on-response="handleResponse"
    debounce-duration="300"></iron-ajax>

	<div id="destroyable" on-tap="registerClick">
        <span>Please log in to join a game.</span>
	</div>
    <div id="start" class="hidden">
        <paper-button id="startbutton" on-tap="startGame" disabled raised>Waiting for players...</paper-button>
	</div>
    <div id="gameslist" class="hidden">
        <div>Open games:<ul id="opengames">
            <template is="dom-repeat" items="{{openGames}}" as="item">
            <li><a href$="{{gameTag(item.id)}}" on-tap="gameTapped">[[item.name]]</a> - <span>[[item.players]]</span>
            </template>
        </ul></div>
        <div>Your games:<ul id="yourgames">
            <template is="dom-repeat" items="{{yourGames}}" as="item">
            <li><a href$="{{gameTag(item.id)}}" on-tap="gameTapped">[[item.name]]</a> - <span>[[item.players]]</span>
            </template>
        </ul></div>
        <paper-button raised on-tap="newGameDialog">Create new game</paper-button>
    </div>
	<div id="modal" class="hidden">
		<div id="overlay" on-tap="hideModal">
		</div>
		<div id="dialog">
			<div id="hintinputs" class="hidden">
                <fireworks-card id="hintscard" faceup></fireworks-card>
                <div>
                    <paper-button raised id="hintnumber" on-tap="giveNumberHint">Hint number</paper-button>
                    <paper-button raised id="hintcolor" on-tap="giveColorHint">Hint color</paper-button>
                </div>
			</div>
			<div id="playinputs" class="hidden">
                <fireworks-card id="playcard"></fireworks-card>
                <div>
                    <paper-button raised id="play" on-tap="play">Play</paper-button>
                    <paper-button raised id="discard" on-tap="discard">Discard</paper-button>
                </div>
			</div>
            <div id="error" class="hidden">
                <span id="errortext">Error text goes here.</span>
                <div>
                    <paper-button raised id="errorok" on-tap="hideModal">OK</paper-button>
                </div>
            </div>
            <div id="end" class="hidden">
                <span id="endtext">End text goes here.</span>
                <div>Final score: <span id="score">0</span></div>
            </div>
            <div id="discarddialog" class="hidden">
                <div id="discardcontainer">
                </div>
                <paper-button id="dialogok" on-tap="hideModal">OK</paper-button>
            </div>
            <div id="newgame" class="hidden">
				<paper-input id="gameid" label="Game name" value="[[suggestGame]]"></paper-input>
                <div class="buttoncontainer">
				<paper-button raised on-tap="submitJoinGame">Create game</paper-button>
                </div>
		    </div>
		</div>
	</div>
	<div id="spinner" class="hidden">
		<paper-spinner active></paper-spinner>
	</div>
  </template>

  <script>
    Polymer({
      is: "fireworks-gamecontroller",

      properties: {
      	localPlayer: {
      		type: String
      	},
        playerToken: {
            type: String
        },
      	gameid: {
      		type: String
      	},
      	gamesequence: {
      		type: Number,
      		readOnly: true
      	},
		polling: {
			type: Boolean,
			value: false
		},
		hintPlayer: {
			type: String
		},
		hintCardIndex: {
			type: Number,
		},
		movePlay: {
			type: Number,
			readOnly: true,
			value: 1
		},
		moveDiscard: {
			type: Number,
			readOnly: true,
			value: 2
		},
		moveHint: {
			type: Number,
			readOnly: true,
			value: 3
		},
		infoNumber: {
			type: Number,
			readOnly: true,
			value: 1
		},
		infoColor: {
			type: Number,
			readOnly: true,
			value: 2
		},
		stateNotStarted: {
			type: Number,
			readOnly: true,
			value: 1
		},
		stateStarted: {
			type: Number,
			readOnly: true,
			value: 2
		},
		stateBombedOut: {
			type: Number,
			readOnly: true,
			value: 3
		},
		statePerfect: {
			type: Number,
			readOnly: true,
			value: 4
		},
		stateDeckEmpty: {
			type: Number,
			readOnly: true,
			value: 5
		},
		currentPlayer: {
			type: Number
		},
		suggestGame: {
			type: String,
            observer: "_suggestGameChanged"
		},
		server: {
			type: String,
			value: ""
		},
        done: {
            type: Boolean,
            value: false
        },
        openGames: {
            type: Array
        },
        yourGames: {
            type: Array
        },
        signedIn: {
            type: Boolean,
            value: false
        },
        turn: {
            type: Number
        },
        joinedGame: {
            type: String
        }
	},
    
    gameTag: function(gameName) {
        return "/games/"+gameName
    },
    
    newGameDialog: function() {
        this.$.newgame.classList.remove("hidden");
        this.showModal();
    },
	
	joinGame: function(gameid) {
        if(this.joinedGame == gameid) {
            return;
        }
        this.joinedGame = gameid;
		this.gameid = gameid;
		this.sendData("join",this.makeEmptyMove());
        this.$.gameslist.classList.add("hidden");
	},
    
    submitJoinGame: function(e) { 
        e.preventDefault();
        this.suggestGame = this.$.gameid.value;
        this.hideModal();
        this.showSpinner();
        var gameid = this.$.gameid.value;
		if(gameid != "") {
			this.joinGame(gameid);
		}
    },
	
	startGame: function(e) {
		this.sendData("start",this.makeEmptyMove())
		this.$.start.classList.add("hidden");
	},
	
	sendData: function(command, data) {
		var ajax = this.$.ajax;
		ajax.url = this.server+"/api/" + command;
		ajax.body = "data=" + data;
		ajax.generateRequest();
	},

    requestStats: function() {
        this.sendData("stats",this.makeEmptyMove());
    },
	
	makeMove: function(movetype, cardindex, hintplayer, hintinfotype) {
		var move = {Game: this.gameid,
				Player: this.localPlayer,
				MoveType: movetype,
				CardIndex: cardindex,
				HintPlayer: hintplayer,
				HintInfoType: hintinfotype,
                Token: this.playerToken
				};
	
		return JSON.stringify(move);
	},
	
	makeEmptyMove: function()
	{
		return this.makeMove(0, 0, "", 0);
	},
	
	handleResponse: function(request) {
		var json = request.detail.response;
        if(json == null) {
            return;
        }

        if(typeof json.error !== 'undefined')
        {
            this.$.errortext.innerHTML = this.sanitize(json.error);
            this.$.error.classList.remove("hidden");
            this.showModal();
            return;
        }
        if(typeof json.OpenGames !== 'undefined') {
            this.yourGames = Array();
            this.openGames = Array();
            for(var i in json.PlayersGames) {
                thisGame = json.PlayersGames[i];
                this.push('yourGames',{ id: thisGame.ID, name: thisGame.Name, players: thisGame.Players })
            }
            for(var i in json.OpenGames) {
                thisGame = json.OpenGames[i];
                this.push('openGames',{ id: thisGame.ID, name: thisGame.Name, players: thisGame.Players })
            }
            
            this.hideSpinner();
            this.$.gameslist.classList.remove("hidden");
            this.joinedGame = '';
            this.turn = -1;
            return;
        }
        if(typeof json.Stats !== 'undefined') {
            document.getElementById("stats").processJSON(json);
            return;
        }
        if(!json.State) {
            return;
        }
        if(json.State != this.stateNotStarted && json.State != this.stateStarted)
        {
            this.done = true;
            var text;
            if(json.State == this.stateBombedOut) { 
                text = "You exploded all of your bombs!";
            } else if(json.State == this.statePerfect) {
                text = "You got a perfect score!";
            } else if(json.State == this.stateDeckEmpty) {
                text = "You ran out of moves!";
            }
            var score = 0;
            for(pile in json.Piles)
            {
                score += json.Piles[pile];
            }
            this.$.endtext.innerHTML = text;
            this.$.score.innerHTML = score;
            this.$.end.classList.remove("hidden");
            this.showModal();
        }
        
        if(this.suggestGame != json.ID) {
            this.suggestGame = json.ID
            history.pushState(null, null, "#!/games/" + json.ID)
            this.turn = -1;
        }
		
        if(this.turn == json.Turn) {
            return;
        }
        
		var newGame = new FireworksGame(this.localPlayer, json.Hints, json.Bombs, json.Piles, json.PileCards, json.Discard, json.CardsLeft, json.CardsLastModified);
        
        var playerIndex = -1;
        for(player in json.Players) {
			if(json.Players[player].GoogleID == this.localPlayer)
			{
				playerIndex = parseInt(player);
			}
        }
        
		for(i in json.Players) {
            player = (playerIndex + parseInt(i)) % json.Players.length;
			var thisPlayer = newGame.addPlayer(json.Players[player].GoogleID, json.Players[player].Name, json.Players[player].LastMove, []);
			if(json.Players[player].GoogleID == json.CurrentPlayer)
			{
				thisPlayer.setCurrentPlayer();
			}
			var index = 0;
			for(card in json.Players[player].Cards) {
				var card = thisPlayer.addCard(json.Players[player].Cards[card].ID, json.Players[player].Cards[card].Color, json.Players[player].Cards[card].Number, json.Players[player].Cards[card].KnownColor, json.Players[player].Cards[card].KnownNumber, index);
                if(newGame.cardShouldBeHighlighted(card.id)) {
                    card.setHighlighted(true);
                }
                index++;
			}
		}
		this.destroyGame();
		Polymer.dom(this.root).querySelector("#destroyable").appendChild(newGame);
        this.$.destroyable.classList.remove("hidden");
    
        if(json.State == this.stateNotStarted) {
            this.$.start.classList.remove("hidden");
            if(json.Players.length > 1)
            {
                Polymer.dom(this.$.startbutton).innerHTML = "Start game";
                this.$.startbutton.disabled = false;
            }
        }
        else {
            this.$.start.classList.add("hidden");
        }

		if(!this.polling)
		{
			this.polling = true;
			this.poll();
		}
		this.currentPlayer = json.CurrentPlayer;     
		this.hideSpinner();
        
        if(this.currentPlayer == this.localPlayer && this.turn != json.Turn && "vibrate" in navigator)
        {
            navigator.vibrate([100, 100, 100]);
        }
        this.turn = json.Turn
	},
			
	
	poll: function() {
        if(!this.polling) {
            return;
        }
		this.sendData("status",this.makeEmptyMove());
		if(!this.done) this.async(this.poll, 5000);
	},
	
    gameTapped: function(e) {
        this.joinGame(e.model.item.id);
    },
		  
	registerClick: function(event) {
	
		if(event.target.className.indexOf("fireworks-card") > -1) {
			var target = event.target;
            
			while(target.localName != "fireworks-card") {
				target = target.parentElement;
                
                if(target.className.indexOf("discard") > -1) {
                    this.showDiscardDialog(target);
                    return;
                }
			}
            
            
            if(this.currentPlayer != this.localPlayer || this.done) {
                return;
            }
            
            var targetCard = target;
			var number = target.getNumber();
			var color = target.getColor();
			
			while(target.localName != "fireworks-player") {
				if(target.parentElement == null) {
					return;
				}
				target = target.parentElement;
			}
			this.hintPlayer = target.getID();
                        
            var dialogcard;
            if(this.hintPlayer == this.localPlayer) {
                dialogcard = this.$.playcard;
            } else {
                dialogcard = this.$.hintscard;
            }
            
			dialogcard.setNumber(number);
			dialogcard.setColor(color);
			dialogcard.setKnownNumber(targetCard.getKnownNumber());
			dialogcard.setKnownColor(targetCard.getKnownColor());
			this.hintCardIndex = targetCard.getIndex();
			
			if(this.hintPlayer == this.localPlayer) {
				this.$.playinputs.classList.remove("hidden");
				
			}
			else {
                Polymer.dom(this.$.hintnumber).innerHTML = "Hint " + number;
                Polymer.dom(this.$.hintcolor).innerHTML = "Hint " + color;
				this.$.hintinputs.classList.remove("hidden");
			}
			this.showModal();
	
		}
	},
	
	hideModal: function() {
        if(this.done) {
            return;
        }
		this.$.modal.classList.add("hidden");
        for(i=0; i<this.$.dialog.children.length; i++)
        {
            this.$.dialog.children[i].classList.add("hidden");
        }
	},
    showModal: function() {
        this.$.modal.classList.remove("hidden");
    },
	showSpinner: function() {
		this.$.spinner.classList.remove("hidden");
	},
	hideSpinner: function() {
		this.$.spinner.classList.add("hidden");
	},
	
	giveHint: function(infotype) {
		var data = this.makeMove(this.moveHint, this.hintCardIndex, this.hintPlayer, infotype);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	},
	
	giveNumberHint: function() {
		this.giveHint(this.infoNumber);
	},
	giveColorHint: function() {
		this.giveHint(this.infoColor);
	},
	
	play: function () {
		this.playOrDiscard(this.movePlay);
	},
	discard: function() {
		this.playOrDiscard(this.moveDiscard);
	},
	playOrDiscard: function(movetype) {
		var data = this.makeMove(movetype, this.hintCardIndex, this.hintPlayer, 0);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	},
    sanitize: function(string)
    {
        return string.replace(/</gi,'&lt;').replace(/>/gi,'&gt;').replace(/"/gi,'&quot;');
    },
    
    showDiscardDialog: function(card) {
        var discardHolder = card.parentElement;
        var discards = [];
        var color = card.getColor();
        for(var i=0; i<discardHolder.children.length; i++) {
            var candidateCard = discardHolder.children[i];
            if(candidateCard.getColor() == color) {
                discards.push(candidateCard.getNumber());
            }
        }
        discards.sort();
        
        this.$.discardcontainer.innerHTML = "";
        for(var i in discards)
        {
            var newCard = new FireworksCard(-1, card.getColor(), discards[i], -1);
            newCard.setFaceup(true);
            Polymer.dom(this.root).appendChild(newCard);
            Polymer.dom(this.root).querySelector("#discardcontainer").appendChild(newCard);
        }
        this.showModal();
        this.$.discarddialog.classList.remove("hidden");
    },
    
    setPlayer: function(id, token) {
        this.localPlayer = id
        this.playerToken = token
        this.showSpinner();
        this.$.destroyable.classList.add("hidden");
        this.signedIn = true
        this.gameChanged();
        
    },
    
    _suggestGameChanged: function(newvalue, oldvalue) {
        this.gameChanged();
    },
    
    gameChanged: function() {
        if(!this.signedIn) {
            return
        }
        this.done = false
        this.hideModal();
        if(this.suggestGame) {
            this.joinGame(this.suggestGame);
        }
        else {
            this.polling = false
            this.showSpinner();
            this.destroyGame();
            this.sendData("list", this.makeEmptyMove());
        }
    },
    
    destroyGame: function () {
    
        this.$.destroyable.classList.add("hidden");
        if(this.$.destroyable.children[0]) {
            this.$.destroyable.children[0].remove();
        }
    },
    ready: function() {
        this.requestStats();
    }
	
    });
  </script>

</dom-module>
