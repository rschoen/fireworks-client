
<dom-module id="fireworks-gamecontroller">
<style>
.hidden { display: none; }

#overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.3);
	z-index: 4;
}

#dialog {
	position: fixed;
	width: 200px;
	top: 50%;
	left: 50%;
	margin-top: -100px;
	margin-left: -120px;
	border: 1px solid #333;
	background: white;
	border-radius: 3px;
	padding: 20px;
	text-align: center;
	z-index: 5;
}

#dialog fireworks-card {
	margin-bottom: 10px;
}

#spinner {
	position: fixed;
	width: 100px;
	height: 100px;
	top: 50%;
	left: 50%;
	margin-top: -50px;
	margin-left: -50px;
	--spinner-stroke-width: 5px;
}

#start {
	position: relative;
	top: 437px;
	left: 20px;
    width: 300px;
    text-align: center;
    z-index: 3;
}

#end div {
    margin-top: 20pt;
    font-size: 18pt;
    font-weight: bold;
}

#error span {
    color: red;
}
#error div {
    margin-top: 30px;
}

input {
    font-size: 16pt;
}

#nameform {
    padding: 10px;
}

</style>
  
  <template>
  <iron-ajax
	id="ajax"
	method="POST"}
    url="/api/"
    handle-as="json"
    on-response="handleResponse"
    debounce-duration="300"></iron-ajax>
    <div id="start" class="hidden">
		<input type="button" value="Waiting for players..." id="startbutton" on-click="startGame" disabled />
	</div>
	<div id="destroyable" on-click="registerClick">
		<div id="nameform">
			<form on-submit="joinGame" action="#">
				Name: <input type="text" id="localPlayerName" value="{{suggestName}}"/><br />
				Game: <input type="text" id="gameid" value="{{suggestGame}}"/><br />
				<input type="submit" value="Join"/>
			</form>
		</div>
	</div>
	<div id="modal" class="hidden">
		<div id="overlay" on-click="hideModal">
		</div>
		<div id="dialog">
			<div id="hintinputs" class="hidden">
                <fireworks-card id="hintscard" faceup></fireworks-card>
                <div>
                    <input id="hintnumber" type="button" value="Hint Number" on-click="giveNumberHint" />
                    <input id="hintcolor" type="button" value="Hint Color"  on-click="giveColorHint" />
                </div>
			</div>
			<div id="playinputs" class="hidden">
                <fireworks-card id="playcard"></fireworks-card>
                <div>
                    <input id="play" type="button" value="Play" on-click="play" />
                    <input id="discard" type="button" value="Discard" on-click="discard" />
                </div>
			</div>
            <div id="error" class="hidden">
                <span id="errortext">Error text goes here.</span>
                <div>
                    <input id="errorok" type="button" value="Close" on-click="hideModal" />
                </div>
            </div>
            <div id="end" class="hidden">
                <span id="endtext">End text goes here.</span>
                <div>Final score: <span id="score">0</span></div>
            </div>
            <div id="discarddialog" class="hidden">
                <div id="discardcontainer">
                </div>
                <input id="dialogok" type="button" value="Close" on-click="hideModal" />
            </div>
		</div>
	</div>
	<div id="spinner" class="hidden">
		<paper-spinner active></paper-spinner>
	</div>
  </template>

  <script>
    Polymer({
      is: "fireworks-gamecontroller",

      properties: {
      	localPlayerName: {
      		type: String
      	},
      	gameid: {
      		type: String
      	},
      	gamesequence: {
      		type: Number,
      		readOnly: true
      	},
		polling: {
			type: Boolean,
			value: false
		},
		hintPlayerName: {
			type: String
		},
		hintCardIndex: {
			type: Number,
		},
		movePlay: {
			type: Number,
			readOnly: true,
			value: 1
		},
		moveDiscard: {
			type: Number,
			readOnly: true,
			value: 2
		},
		moveHint: {
			type: Number,
			readOnly: true,
			value: 3
		},
		infoNumber: {
			type: Number,
			readOnly: true,
			value: 1
		},
		infoColor: {
			type: Number,
			readOnly: true,
			value: 2
		},
		stateNotStarted: {
			type: Number,
			readOnly: true,
			value: 1
		},
		stateStarted: {
			type: Number,
			readOnly: true,
			value: 2
		},
		stateBombedOut: {
			type: Number,
			readOnly: true,
			value: 3
		},
		statePerfect: {
			type: Number,
			readOnly: true,
			value: 4
		},
		stateDeckEmpty: {
			type: Number,
			readOnly: true,
			value: 5
		},
		currentPlayer: {
			type: String
		},
		suggestName: {
			type: String,
            observer: "_checkAutoSubmit"
		},
		suggestGame: {
			type: String,
            observer: "_checkAutoSubmit"
		},
		server: {
			type: String,
			value: ""
		},
        done: {
            type: Boolean,
            value: false
        }
	},
	
	joinGame: function(e) {
		if (e) e.preventDefault();
		var name = this.$.localPlayerName.value;
		var gameid = this.$.gameid.value;
		if(name != "" && gameid != "") {
			this.localPlayerName = name;
			this.gameid = gameid;
			this.sendData("join",this.makeEmptyMove());
		}
	},
	
	startGame: function(e) {
		this.sendData("start",this.makeEmptyMove())
		this.$.start.classList.add("hidden");
	},
	
	sendData: function(command, data) {
		var ajax = this.$.ajax;
		ajax.url = this.server+"/api/" + command;
		ajax.body = "data=" + data;
		ajax.generateRequest();
	},
	
	makeMove: function(movetype, cardindex, hintplayer, hintinfotype) {
		var move = {Game: this.gameid,
				Player: this.localPlayerName,
				MoveType: movetype,
				CardIndex: cardindex,
				HintPlayer: hintplayer,
				HintInfoType: hintinfotype
				};
	
		return JSON.stringify(move);
	},
	
	makeEmptyMove: function()
	{
		return this.makeMove(0, 0, "null", 0);
	},
	
	
	
	handleResponse: function(request) {
		var json = request.detail.response;
        if(json.error != undefined)
        {
            this.$.errortext.innerHTML = this.sanitize(json.error);
            this.$.error.classList.remove("hidden");
            this.showModal();
            return;
        }
        if(json.State != this.stateNotStarted && json.State != this.stateStarted)
        {
            this.done = true;
            var text;
            if(json.State == this.stateBombedOut) { 
                text = "You exploded all of your bombs!";
            } else if(json.State == this.statePerfect) {
                text = "You got a perfect score!";
            } else if(json.State == this.stateDeckEmpty) {
                text = "You ran out of moves!";
            }
            var score = 0;
            for(pile in json.Piles)
            {
                score += json.Piles[pile];
            }
            this.$.endtext.innerHTML = text;
            this.$.score.innerHTML = score;
            this.$.end.classList.remove("hidden");
            this.showModal();
        }
		
		var newGame = new FireworksGame(this.localPlayerName, json.Hints, json.Bombs, json.Piles, json.Discard, json.CardsLeft);
		for(player in json.Players) {
			var thisPlayer = newGame.addPlayer(json.Players[player].ID,[]);
			if(json.Players[player].ID == json.CurrentPlayer)
			{
				thisPlayer.setCurrentPlayer();
			}
			var index = 0;
			for(card in json.Players[player].Cards) {
				thisPlayer.addCard(json.Players[player].Cards[card].ID, json.Players[player].Cards[card].Color, json.Players[player].Cards[card].Number, json.Players[player].Cards[card].KnownColor, json.Players[player].Cards[card].KnownNumber, index);
				index++;
			}
		}
		this.$.destroyable.children[0].remove();
		Polymer.dom(this.root).querySelector("#destroyable").appendChild(newGame);
    
        if(json.State == this.stateNotStarted) {
            this.$.start.classList.remove("hidden");
        }
        else {
            this.$.start.classList.add("hidden");
            if(json.Players.length > 1)
            {
                this.$.startbutton.value = "Start game";
                this.$.startbutton.disabled = false;
            }
        }

		if(!this.polling)
		{
			this.polling = true;
			this.poll();
		}
		this.currentPlayer = json.CurrentPlayer;
		this.hideSpinner();
	},
			
	
	poll: function() {
		this.sendData("status",this.makeEmptyMove());
		if(this.polling && !this.done) this.async(this.poll, 5000);
	},
	
		  
	registerClick: function(event) {
	
		if(event.target.className.indexOf("fireworks-card") > -1) {
			var target = event.target;
            
			while(target.localName != "fireworks-card") {
				target = target.parentElement;
                
                if(target.className.indexOf("discard") > -1) {
                    this.showDiscardDialog(target);
                    return;
                }
			}
            
            
            if(this.currentPlayer != this.localPlayerName || this.done) {
                return;
            }
            
            var targetCard = target;
			var number = target.getNumber();
			var color = target.getColor();
			
			while(target.localName != "fireworks-player") {
				if(target.parentElement == null) {
					return;
				}
				target = target.parentElement;
			}
			this.hintPlayerName = target.getName();
                        
            var dialogcard;
            if(this.hintPlayerName == this.localPlayerName) {
                dialogcard = this.$.playcard;
            } else {
                dialogcard = this.$.hintscard;
            }
            
			dialogcard.setNumber(number);
			dialogcard.setColor(color);
			dialogcard.setKnownNumber(targetCard.getKnownNumber());
			dialogcard.setKnownColor(targetCard.getKnownColor());
			this.hintCardIndex = targetCard.getIndex();
			
			if(this.hintPlayerName == this.localPlayerName) {
				this.$.playinputs.classList.remove("hidden");
				
			}
			else {
                this.$.hintnumber.value = "Hint " + number;
                this.$.hintcolor.value = "Hint " + color;
				this.$.hintinputs.classList.remove("hidden");
			}
			this.showModal();
	
		}
	},
	
	hideModal: function() {
        if(this.done) {
            return;
        }
		this.$.modal.classList.add("hidden");
        for(i=0; i<this.$.dialog.children.length; i++)
        {
            this.$.dialog.children[i].classList.add("hidden");
        }
	},
    showModal: function() {
        this.$.modal.classList.remove("hidden");
    },
	showSpinner: function() {
		this.$.spinner.classList.remove("hidden");
	},
	hideSpinner: function() {
		this.$.spinner.classList.add("hidden");
	},
	
	giveHint: function(infotype) {
		var data = this.makeMove(this.moveHint, this.hintCardIndex, this.hintPlayerName, infotype);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	},
	
	giveNumberHint: function() {
		this.giveHint(this.infoNumber);
	},
	giveColorHint: function() {
		this.giveHint(this.infoColor);
	},
	
	play: function () {
		this.playOrDiscard(this.movePlay);
	},
	discard: function() {
		this.playOrDiscard(this.moveDiscard);
	},
	playOrDiscard: function(movetype) {
		var data = this.makeMove(movetype, this.hintCardIndex, this.hintPlayerName, 0);
		this.sendData("move",data);
		this.hideModal();
		this.showSpinner();
	},
    sanitize: function(string)
    {
        return string.replace(/</gi,'&lt;').replace(/>/gi,'&gt;').replace(/"/gi,'&quot;');
    },
    
    showDiscardDialog: function(card) {
        var discardHolder = card.parentElement;
        var discards = [];
        var color = card.getColor();
        for(var i=0; i<discardHolder.children.length; i++) {
            var candidateCard = discardHolder.children[i];
            if(candidateCard.getColor() == color) {
                discards.push(candidateCard.getNumber());
            }
        }
        discards.sort();
        
        this.$.discardcontainer.innerHTML = "";
        for(var i in discards)
        {
            var newCard = new FireworksCard(-1, card.getColor(), discards[i], -1);
            newCard.setFaceup(true);
            Polymer.dom(this.root).appendChild(newCard);
            Polymer.dom(this.root).querySelector("#discardcontainer").appendChild(newCard);
        }
        this.showModal();
        this.$.discarddialog.classList.remove("hidden");
    },
    
    _checkAutoSubmit: function(oldvalue, newvalue) {
        if(this.suggestName != "" && this.suggestGame != "" )
        {
            this.joinGame();
        }
    }
	
    });
  </script>

</dom-module>
